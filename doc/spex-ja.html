<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">

<head>
<meta http-equiv="Content-Language" content="ja" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta name="author" content="Mikio Hirabayashi" />
<meta name="keywords" content="Tokyo Cabinet, tokyocabinet, database, DBM" />
<meta name="description" content="Specifications of Tokyo Cabinet" />
<link rel="contents" href="./" />
<link rel="alternate" href="spex-en.html" hreflang="en" title="the English version" />
<link rel="stylesheet" href="common.css" />
<link rel="icon" href="icon16.png" />
<link rev="made" href="mailto:mikio@users.sourceforge.net" />
<title>Specifications of Tokyo Cabinet Version 1 (Japanese)</title>
</head>

<body>

<h1>Tokyo Cabinet第1版仕様書</h1>

<div class="note">Copyright (C) 2006-2007 Mikio Hirabayashi</div>
<div class="note">Last Update: Mon, 16 Jul 2007 19:45:16 +0900</div>
<div class="navi">[<a href="spex-en.html" hreflang="en">English</a>/<span class="void">Japanese</span>] [<a href="index.ja.html">HOME</a>]</div>

<hr />

<h2 id="tableofcontents">目次</h2>

<ol>
<li><a href="#introduction">はじめに</a></li>
<li><a href="#installation">インストール</a></li>
<li><a href="#tchdbapi">ハッシュデータベースAPI</a></li>
<li><a href="#tcutilapi">ユーティリティAPI</a></li>
<li><a href="#format">データベースフォーマット</a></li>
<li><a href="#license">ライセンス</a></li>
</ol>

<hr />

<h2 id="introduction">はじめに</h2>

<p>Tokyo Cabinetはデータベースを扱うルーチン群のライブラリです。データベースといっても単純なもので、キーと値のペアからなるレコード群を格納したデータファイルです。キーと値は任意の長さを持つ一連のバイト列であり、文字列でもバイナリでも扱うことができます。テーブルやデータ型の概念はありません。レコードはハッシュ表で編成されます。</p>

<p>ハッシュ表のデータベースでは、キーはデータベース内で一意であり、キーが重複する複数のレコードを格納することはできません。このデータベースに対しては、キーと値を指定してレコードを格納したり、キーを指定して対応するレコードを削除したり、キーを指定して対応するレコードを検索したりすることができます。また、データベースに格納してある全てのキーを順不同に一つずつ取り出すこともできます。このような操作は、UNIX標準で定義されている DBMライブラリおよびその追従であるNDBMやGDBMに類するものです。Tokyo CabinetはDBMのより良い代替として利用することができます。</p>

<hr />

<h2 id="installation">インストール</h2>

<p>Tokyo Cabinetのソースパッケージからのインストール方法を説明します。バイナリパッケージのインストール方法についてはそれぞれのパッケージの説明書をご覧ください。</p>

<h3>前提</h3>

<p>Tokyo Cabinetの現在バージョンは、UNIX系のOSで利用することができます。少なくとも、以下の環境では動作するはずです。</p>

<ul>
<li>Linux 2.4以降 (IA32/IA64/AMD64)</li>
</ul>

<p>ソースパッケージを用いてTokyo Cabinetをインストールするには、<code>gcc</code>のバージョン3.1以降と<code>make</code>が必要です。それらはLinuxやFreeBSDには標準的にインストールされています。</p>

<p>Tokyo Cabinetは、以下のライブラリを利用しています。予めそれらをインストールしておいてください。</p>

<ul>
<li><a href="http://www.gzip.org/zlib/">zlib</a> : 可逆データ圧縮。バージョン1.2.1以降。</li>
</ul>

<h3>ビルドとインストール</h3>

<p>Tokyo Cabinetの配布用アーカイブファイルを展開したら、生成されたディレクトリに入ってインストール作業を行います。</p>

<p><code>configure</code>スクリプトを実行して、ビルド環境を設定します。</p>

<pre>./configure
</pre>

<p>プログラムをビルドします。</p>

<pre>make
</pre>

<p>プログラムの自己診断テストを行います。</p>

<pre>make check
</pre>

<p>プログラムをインストールします。作業は<code>root</code>ユーザで行います。</p>

<pre>make install
</pre>

<h3>結果</h3>

<p>一連の作業が終ると、以下のファイルがインストールされます。</p>

<pre>/usr/local/include/tcutil.h
/usr/local/include/tchdb.h
/usr/local/lib/libtokyocabinet.a
/usr/local/lib/libtokyocabinet.so.1.6.0
/usr/local/lib/libtokyocabinet.so.1
/usr/local/lib/libtokyocabinet.so
/usr/local/share/tokyocabinet/...
/usr/local/man/man1/...
/usr/local/man/man3/...
</pre>

<h3>configureのオプション</h3>

<p>「./configure」を実行する際には、以下のオプションを指定することができます。</p>

<ul>
<li><kbd>--enable-debug</kbd> : デバッグ用にビルドします。デバッグシンボルを有効化し、最適化を行わず、静的にリンクします。</li>
<li><kbd>--enable-devel</kbd> : 開発用にビルドします。デバッグシンボルを有効化し、最適化を行い、動的にリンクします。</li>
<li><kbd>--enable-profile</kbd> : プロファイル用にビルドします。プロファイルオプションを有効化し、最適化を行い、動的にリンクします。</li>
<li><kbd>--enable-fastest</kbd> : 最高速になるように最適化を行います。</li>
<li><kbd>--enable-swab</kbd> : バイトオーダの変換を強制します。</li>
<li><kbd>--disable-zlib</kbd> : ZLIBによるレコード圧縮を無効にします。</li>
<li><kbd>--disable-pthread</kbd> : POSIXスレッドのサポートを無効にします。</li>
<li><kbd>--disable-shared</kbd> : 共有ライブラリのビルドを行いません。</li>
</ul>

<hr />

<h2 id="tchdbapi">ハッシュデータベースAPI</h2>

<p>とりあえずヘッダ（tchdb.h）読んでね。</p>

<hr />

<h2 id="tcutilapi">ユーティリティAPI</h2>

<p>とりあえずヘッダ（tcutil.h）読んでね。</p>

<hr />

<h2 id="format">データベースフォーマット</h2>

<p>この節ではデータベースファイルのフォーマットに関する仕様を示す。</p>

<h3>ハッシュデータベースのファイルフォーマット</h3>

<p>ハッシュデータベースが管理するデータベースファイルの内容は、ヘッダ部、バケット部、フリーブロックプール部、レコード部の4つに大別される。ファイルに記録される数値は固定長数値もしくは可変長数値として記録される。前者は数値を特定の領域にリトルエンディアンで直列化したものである。後者は数値を可変長の領域に128進法のデルタ符号で直列化したものである。</p>

<p>ヘッダ部はファイルの先頭から128バイトの固定長でとられ、以下の情報が記録される。</p>

<table summary="database header format">
<tr>
<td class="label">名前</td>
<td class="label">オフセット</td>
<td class="label">データ長</td>
<td class="label">機能</td>
</tr>
<tr>
<td>マジックナンバ</td>
<td class="number">0</td>
<td class="number">32</td>
<td>データベースファイルであることの判別。「ToKyO CaBiNeT」で始まる</td>
</tr>
<tr>
<td>データベースタイプ</td>
<td class="number">32</td>
<td class="number">1</td>
<td>ハッシュ表（1）かB+木（2）</td>
</tr>
<tr>
<td>追加フラグ</td>
<td class="number">33</td>
<td class="number">1</td>
<td>開きっぱなし（1&lt;&lt;0）、致命的エラー（1&lt;&lt;1）の論理和</td>
</tr>
<tr>
<td>アラインメント力</td>
<td class="number">34</td>
<td class="number">1</td>
<td>アラインメントに対する2の冪乗</td>
</tr>
<tr>
<td>フリーブロックプール力</td>
<td class="number">34</td>
<td class="number">1</td>
<td>フリーブロックプールの要素数に対する2の冪乗</td>
</tr>
<tr>
<td>オプション</td>
<td class="number">36</td>
<td class="number">1</td>
<td>ラージモード（1&lt;&lt;0）、圧縮モード（1&lt;&lt;1）の論理和</td>
</tr>
<tr>
<td>バケット数</td>
<td class="number">40</td>
<td class="number">8</td>
<td>バケット配列の要素数</td>
</tr>
<tr>
<td>レコード数</td>
<td class="number">48</td>
<td class="number">8</td>
<td>格納しているレコードの数</td>
</tr>
<tr>
<td>ファイルサイズ</td>
<td class="number">56</td>
<td class="number">8</td>
<td>データベースファイルのサイズ</td>
</tr>
<tr>
<td>先頭レコード</td>
<td class="number">64</td>
<td class="number">8</td>
<td>最初のレコードのオフセット</td>
</tr>
<tr>
<td>不透明領域</td>
<td class="number">80</td>
<td class="number">48</td>
<td>ユーザが自由に使える領域</td>
</tr>
</table>

<p>バケット部はヘッダ部の直後にバケット配列の要素数に応じた大きさでとられ、ハッシュチェーンの先頭要素のオフセットが各要素に記録される。各要素は固定長数値であり、そのサイズはノーマルモードでは4バイト、ラージモードでは8バイトである。また、オフセットはアラインメントで割った商として記録される。</p>

<p>フリーブロックプール部はバケット部の直後にフリーブロックプールの要素数に応じた大きさでとられ、未使用領域のオフセットと長さが各要素に記録される。オフセットはアラインメントで割った商に変換した上で、直前の要素の値との差分として記録される。オフセットとサイズは可変長数値として扱われる。</p>

<p>レコード部はバケット部の直後からファイルの末尾までを占め、各レコードの以下の情報を持つ要素が記録される。各レコードの領域は常にアラインメントされた位置から始まる。</p>

<table summary="record format">
<tr>
<td class="label">名前</td>
<td class="label">オフセット</td>
<td class="label">データ長</td>
<td class="label">機能</td>
</tr>
<tr>
<td>マジックナンバ</td>
<td class="number">0</td>
<td class="number">1</td>
<td>データの識別と整合性確認に用いる。0xA1固定</td>
</tr>
<tr>
<td>ハッシュ値</td>
<td class="number">1</td>
<td class="number">1</td>
<td>チェーンの進路決定に用いるハッシュ値</td>
</tr>
<tr>
<td>左チェーン</td>
<td class="number">2</td>
<td class="number">4</td>
<td>左チェーン接続先のオフセットのアラインメント商</td>
</tr>
<tr>
<td>右チェーン</td>
<td class="number">6</td>
<td class="number">4</td>
<td>右チェーン接続先のオフセットのアラインメント商</td>
</tr>
<tr>
<td>パディングサイズ</td>
<td class="number">10</td>
<td class="number">2</td>
<td>パディングのサイズ</td>
</tr>
<tr>
<td>キーサイズ</td>
<td class="number">12</td>
<td class="number">可変</td>
<td>キーのサイズ</td>
</tr>
<tr>
<td>値サイズ</td>
<td class="number">可変</td>
<td class="number">可変</td>
<td>値のサイズ</td>
</tr>
<tr>
<td>キー</td>
<td class="number">可変</td>
<td class="number">可変</td>
<td>キーのデータ</td>
</tr>
<tr>
<td>値</td>
<td class="number">可変</td>
<td class="number">可変</td>
<td>値のデータ</td>
</tr>
<tr>
<td>パディング</td>
<td class="number">可変</td>
<td class="number">可変</td>
<td>パディング</td>
</tr>
</table>

<p>ただし、フリーブロックとなった領域には、各レコードの以下の情報を持つ要素が記録される。</p>

<table summary="record format">
<tr>
<td class="label">名前</td>
<td class="label">オフセット</td>
<td class="label">データ長</td>
<td class="label">機能</td>
</tr>
<tr>
<td>マジックナンバ</td>
<td class="number">0</td>
<td class="number">1</td>
<td>データの識別と整合性確認に用いる。0xA2固定</td>
</tr>
<tr>
<td>ブロックサイズ</td>
<td class="number">1</td>
<td class="number">4</td>
<td>ブロックのサイズ</td>
</tr>
</table>

<p>あと細かいことがいろいろあるけど、割愛。</p>

<hr />

<h2 id="license">ライセンス</h2>

<p>Tokyo Cabinetはフリーソフトウェアです。あなたは、Free Software Foundationが公表したGNU Lesser General Public Licenseのバージョン2.1あるいはそれ以降の各バージョンの中からいずれかを選択し、そのバージョンが定める条項に従ってTokyo Cabinetを再頒布または変更することができます。</p>

<p>Tokyo Cabinetは有用であると思われますが、頒布にあたっては、市場性及び特定目的適合性についての暗黙の保証を含めて、いかなる保証も行ないません。詳細についてはGNU Lesser General Public Licenseを読んでください。</p>

<p>あなたは、Tokyo Cabinetと一緒にGNU Lesser General Public Licenseの写しを受け取っているはずです（`<code>COPYING</code>' ファイルを参照してください）。そうでない場合は、Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA へ連絡してください。</p>

<hr />

</body>

</html>

<!-- END OF FILE -->
